---
title: "Extended Language Network | 02_stats"
author: "Agata Wolna [`awolna@mit.edu`], Aaron Wright [`aawva@mit.edu`]"
date: "2025-08-29"
format: html
---

## Overview

**Purpose**: run statistical models for gss and atlas parcels, and create counts of language-selective and language-responsive rois

**Input(s)**: `detail_all.txt`, the main data table

**Process**: run models for the gss n=772, gss n=86, and atlas parcels; describe the distribution of parcels; calculate roi sizes, and create tables of lang-selective and lang-responsive parcels

**Output(s)**: restults/stats/`atlas_model_stats` \| `gss_n772_model_stats` \| `gss_n86_model_stats`: lists of model outputs and optional diagnostics; `atlas_lang_responsive_rois_names.txt` and `atlas_lang_selective_rois_names.txt`: descriptive tables for atlas parcels

## Environment

```{r}
library(tidyverse)
library(here)
library(readxl)
library(lmerTest)
library(emmeans)

source(here("scripts", "run_parcel_models.R"))
```

## Data

```{r}
# read in the data
data_all <- read.delim(here("data", "detail_all.txt")) # ALL participants
```

## Tidying and raw data descriptive statistics

Compute short, summarizing statistics (means and SDs by conditions / tasks / parcels) for GSS and atlas parcels, saving them in dataframes for future use in the pipeline.

### GSS parcels

```{r}
#| eval: false
#| 
# create a data frame to define task effects
effects <- data.frame(
  column1 = c("Alice", "Lang", "MD", "Alice", "Lang", "MD"),
  column2 = c("baseline", "baseline", "baseline", "critical", "critical", "critical"),
  column3 = c("degraded speech", "nonwords", "easy vWM", "intact speech", "sentences", "hard vWM"))
# rename columns
colnames(effects) <- c("task", "condition", "effect")

# --- GSS parcels ---

# import GSS parcels
gcssroi_excluded <- c(9, 29, 30, 31, 32, 33) # exclude unnecessary parcels before recoding

# recode parcels with new ROI numbers
data_gcss <- data_all %>% 
  mutate(condition = as.factor(condition), task = as.factor(task)) %>%
  filter(parcels =="GcSS", !(ROI %in% gcssroi_excluded)) # filter for only desired ROIs

# data, intial n check
data_gcss %>%
  select(Subject, task, localizer) %>%
  unique() %>%
  group_by(localizer, task) %>%
  count()

gss_parcels_recoded <- read.delim(here("data", "recode_parcels.txt"), sep = "\t") %>% # recode parcels with new ROI numbers
  filter(!(ROI %in% gcssroi_excluded)) %>%
  mutate(
    atlas = "GSS",
    lobe = NA_character_) %>%
  rename(
    hemi = hemisphere,
    ROIName = label)

# update df with new recoded parcels
data_gcss_recoded <- data_gcss %>% left_join(gss_parcels_recoded, by = "ROI") %>%
  select(-ROI) %>% # drop old parcel numbers
  rename(ROI = ROI_new) # rename new, recoded parcel numbers

# save intermediate recoded data for use in later scripts
write_csv(data_gcss_recoded, here("results", "tables", "gss_raw_data_detail_all_recoded.csv")) # ALL participants' raw data, with parcels attached

# join with effects + parcels
data_all_recoded_full <- data_gcss_recoded %>%
  left_join(effects, by = c("task", "condition"))
  # rename(roi = ROI, hemisphere = hemi, label = ROIName)

data_all_recoded_gss_full <- data_all_recoded_full %>%
  rename(
    roi = ROI,
    hemisphere = hemi,
    label = ROIName
    ) %>%
  group_by(task, condition, roi, hemisphere, label, effect) %>%
  summarise(
    emmean = mean(EffectSize, na.rm = TRUE),
    se     = sd(EffectSize, na.rm = TRUE) / sqrt(n()),
    lowCI  = emmean - qt(0.975, df = n() - 1) * se,
    highCI = emmean + qt(0.975, df = n() - 1) * se,
    .groups = "drop"
  ) %>%
  mutate(
    atlas = "GSS",
    model = "n=772",
    # enforce factor order to control sorting
    task = factor(task, levels = c("Alice", "Lang", "MD")),
    condition = factor(condition, levels = c("baseline", "critical"))
  ) %>%
  # order the rows within each roi in your desired sequence
  arrange(roi, hemisphere, label, condition, task) %>%
  relocate(task, condition, emmean, se, lowCI, highCI, roi, atlas, effect, hemisphere, label, model)

write_csv(data_all_recoded_gss_full, here("results", "tables", "gss_raw_data_detail_all_recoded_descriptive_stats.csv")) # ALL participants' raw data, with parcels attached
```

### Atlas parcels

```{r}
# --- atlas parcels ---

# read in the atlas-level raw data
data_all_atlas_raw <- read_delim(here("data", "detail_all.txt"), delim = "\t") %>% 
  filter(parcels %in% c("DKT", "Glasser", "HOCortical", "HOSubcortical"))

# join with effects (task-condition-effect mappings)
data_all_atlas_full <- data_all_atlas_raw %>%
  left_join(effects, by = c("task", "condition")) %>%
  group_by(task, condition, roi = ROI, parcels, Effect, effect) %>%
  summarise(
    emmean = mean(EffectSize, na.rm = TRUE),
    se     = sd(EffectSize, na.rm = TRUE) / sqrt(n()),
    lowCI  = emmean - qt(0.975, df = n() - 1) * se,
    highCI = emmean + qt(0.975, df = n() - 1) * se,
    .groups = "drop"
  ) %>%
  mutate(
    model = "Atlas",
    task = factor(task, levels = c("Lang", "Alice", "MD")),
    condition = factor(condition, levels = c("baseline", "critical")),
    effect = factor(effect, c("sentences", "nonwords", "intact speech", 
                              "degraded speech", "hard vWM", "easy vWM"))
  ) %>%
  arrange(parcels, roi, condition, task)

write_csv(data_all_atlas_full, here("results", "tables", "atlas_raw_data_detail_all_descriptive_stats.csv")) # ALL participants' raw data, with parcels attached

```

## Parcel statistical models

Group-constrained specific-subject parcellation method (see Fedorenko et al., 2010 for a description of the approach).

### Parcel model: gss parcels n=772 (full)

``` {r}
# set df to be used in n=772 parcel model
data_gcss_n772 <- data_gcss_recoded

# run parcel model (gss, n=772)
run_parcel_models(data_gcss_n772,
                  parcels_filter="GcSS",
                  target_data="gss_n772",
                  diagnostics=FALSE)
```

### Parcel model: atlas parcels

```{r}
#| eval: false

# atlas data
data_atlas <- data_all %>% 
  mutate(condition = as.factor(condition), task=as.factor(task)) %>% 
  filter(parcels !="GcSS", !is.na(ROI))

# run parcel model (atlas)
atlas_parcels <- c("DKT","Glasser","HOCortical","HOSubcortical")
run_parcel_models(data_atlas,
                  parcels_filter=atlas_parcels,
                  target_data="atlas",
                  diagnostics=FALSE)
```

## Parcel tables: statistical model outputs

### Aggregate data for computing tables

```{r}
# read in the data

# gss n772
gss772_maineffects <- read.table(here("results", "stats", "gss_n772_model_stats", "gss_n772_roi_models_pairwise_maineffects.txt"), sep = "\t", header = TRUE) %>% as_tibble()
gss772_conditions <- read.table(here("results", "stats", "gss_n772_model_stats", "gss_n772_roi_models_pairwise_conditions.txt"), sep = "\t", header = TRUE) %>% as_tibble()
gss772_tasks <- read.table(here("results", "stats", "gss_n772_model_stats", "gss_n772_roi_models_pairwise_tasks.txt"), sep = "\t", header = TRUE) %>% as_tibble()

# atlas
atlas_roi_models_pairwise_maineffects <- read.table(here("results", "stats", "atlas_model_stats", "atlas_roi_models_pairwise_maineffects.txt"), sep = "\t", header = T) %>% as_tibble()
atlas_roi_models_pairwise_conditions <- read.table(here("results", "stats", "atlas_model_stats", "atlas_roi_models_pairwise_conditions.txt"), sep = "\t", header = T) %>% as_tibble()
atlas_roi_models_pairwise_tasks <- read.table(here("results", "stats", "atlas_model_stats", "atlas_roi_models_pairwise_tasks.txt"), sep = "\t", header = T) %>% as_tibble()
```

### Language-selective and language-responsive ROIs (GSS n=772)

```{r}
# Use gss_parcels_recoded from earlier
# Compute responsive and selective ROIs for n=772
## Responsive: S>N and I>D, effect=="critical", estimate>0, p<0.05 for both, and significant contrast between language conditions
gss772_maineffects_rois <- gss772_maineffects %>%
  separate(contrast, into=c("task", "effect")) %>%
  filter(effect=="critical", task!="MD", estimate>0, p_value<0.05) %>%
  group_by(roi) %>%
  count() %>%
  filter(n==2) %>%
  mutate(maineffect=1) %>%
  select(-n)

gss772_responsive_rois <- gss772_conditions %>%
  separate(contrast, into=c("task")) %>%
  filter(task!="MD", p_value<0.05) %>%
  group_by(roi) %>%
  count() %>%
  filter(n==2) %>%
  select(-n) %>%
  left_join(gss772_maineffects_rois, by="roi") %>%
  filter(!is.na(maineffect)) %>%
  select(-maineffect) %>%
  unique()

gss772_selective_rois <- gss772_tasks %>%
  separate(contrast, into=c("task1", "task2"), sep = " vs. ") %>%
  filter(task2 == "criticalMD", estimate>0, p_value<0.05) %>%
  group_by(roi) %>%
  count() %>%
  filter(n==2) %>%
  select(-n) %>%
  mutate(selective=1)

gss772_selective_rois <- gss772_responsive_rois %>%
  left_join(gss772_selective_rois, by="roi") %>%
  filter(!is.na(selective)) %>%
  select(-selective)

# Add ROI names and hemisphere
gss772_responsive_rois <- gss772_responsive_rois %>%
  left_join(gss_parcels_recoded %>% select(ROI=ROI_new, ROIName, hemi), by=c("roi"="ROI")) %>%
  unique()
gss772_selective_rois <- gss772_selective_rois %>%
  left_join(gss_parcels_recoded %>% select(ROI=ROI_new, ROIName, hemi), by=c("roi"="ROI")) %>%
  unique()

# Write tables
write.table(gss772_responsive_rois, here("results", "tables", "gss772_lang_responsive_rois_names.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
write.table(gss772_selective_rois, here("results", "tables", "gss772_lang_selective_rois_names.txt"), sep = "\t", row.names = FALSE, quote = FALSE)
```

### Language-selective and language-responsive ROIs (Atlases)

-   Responsive parcels - S\>N, I\>D

    -   Responsive parcels show a significant difference in activation in the critical task condition, relative to its baseline.

-   Selective parcels - S\>H, I\>H

    -   Selective parcels, in addition to meeting the criteria for responsiveness, show a significant difference in activation in the critical language task conditions over the critical working memory condition.

```{r}
# get a list of language-responsive ROIs (significant S>N and I>D effect, S and I greater than 0)

## which ROIs show response to S and I significantly greater than 0?
maineffects_rois <- atlas_roi_models_pairwise_maineffects %>% 
  separate(contrast, into=c("task", "effect")) %>% 
  as_tibble() %>% 
  filter(effect=="critical", task!="MD", estimate>0, p_value<0.05) %>% 
  group_by(roi, atlas) %>% 
  count() %>% 
  filter(n==2) %>%
  mutate(maineffect = 1) %>% 
  select(-n) 

## which ROIs also show a significant contrast between language conditions?
lang_responsive_rois <- atlas_roi_models_pairwise_conditions %>% 
  separate(contrast, into=c("task")) %>% 
  as_tibble() %>% 
  filter(task!="MD", p_value<0.05) %>%
  group_by(roi, atlas) %>%
  count() %>%
  filter(n==2) %>%
  select(-n) %>% 
  left_join(maineffects_rois) %>%
  filter(!is.na(maineffect)) %>% 
  select(-maineffect) %>%
  unique() 

## which ROIs are language-selective (S>H and I>H)?
lang_selective_rois <- atlas_roi_models_pairwise_tasks %>%
  separate(contrast, into=c("task1", "task2"), sep = " vs. ") %>%
  as_tibble() %>%
  filter(task2 == "criticalMD", estimate>0, p_value<0.05) %>%
  group_by(roi, atlas) %>%
  count() %>% 
  filter(n == 2) %>%
  select(-n) %>%
  mutate(selective = 1) 

# which of the language-responsive ROIs are also language-selective?
lang_selective_rois <- lang_responsive_rois %>%
  left_join(lang_selective_rois) %>%
  filter(!is.na(selective)) %>%
  select(-selective)

## sanity check: counts of selective and responsive ROIs by atlas:
lang_responsive_rois %>% group_by(atlas) %>% count()
lang_selective_rois %>% group_by(atlas) %>% count()

## get parcels names
dktnames <- read_excel(here("data", "AtlasParcels.xlsx"), sheet="DKT") %>% rename(roi=ROI) %>% select(roi, hemi, ROIName) %>% mutate(atlas="DKT")
hocnames=read_excel(here("data", "AtlasParcels.xlsx"), sheet="HOCortical") %>% rename(roi=ROI) %>% select(roi, hemi, ROIName) %>% mutate(atlas="HOCortical")
hosubnames <- read_excel(here("data", "AtlasParcels.xlsx"), sheet="HOSubcortical") %>% rename(roi=ROI) %>% select(roi, hemi, ROIName) %>% mutate(atlas="HOSubcortical")
glassernames <- read_excel(here("data", "AtlasParcels.xlsx"), sheet="Glasser") %>% rename(roi=ROI) %>% select(roi, hemi, ROIName) %>% mutate(atlas="Glasser")

names=rbind(dktnames, hocnames, hosubnames, glassernames)

lang_selective_rois <- lang_selective_rois %>% left_join(names) %>% unique()
lang_responsive_rois <- lang_responsive_rois %>% left_join(names) %>% unique()

# read and combine all atlas sheets into one data frame
atlas_parcels <- bind_rows(
  
  read_excel(here("data", "AtlasParcels.xlsx"), sheet = "DKT") %>%
    rename(roi = ROI) %>%
    mutate(atlas = "DKT") %>%
    select(atlas, roi, lobe, hemi, ROIName),
  
  read_excel(here("data", "AtlasParcels.xlsx"), sheet = "HOCortical") %>%
    rename(roi = ROI) %>%
    mutate(atlas = "HOCortical") %>%
    select(atlas, roi, lobe, hemi, ROIName),
  
  read_excel(here("data", "AtlasParcels.xlsx"), sheet = "HOSubcortical") %>%
    rename(roi = ROI) %>%
    mutate(atlas = "HOSubcortical",
           hemi = case_when(ROIName == "Brain-Stem" ~ NA_character_, TRUE ~ hemi),  # change brain stem hemi value to NA
           lobe = NA) %>%
    select(atlas, roi, lobe, hemi, ROIName),
  
  read_excel(here("data", "AtlasParcels.xlsx"), sheet = "Glasser") %>%
    rename(roi = ROI) %>%
    mutate(atlas = "Glasser") %>%
    select(atlas, roi, lobe, hemi, ROIName)
)

# define responsive and selective rois
lang_responsive_rois <-  lang_responsive_rois %>% left_join(atlas_parcels) %>% distinct()
lang_selective_rois <-  lang_selective_rois %>% left_join(atlas_parcels) %>% distinct()

# write tables
write.table(lang_responsive_rois, here("results", "tables", "atlas_lang_responsive_rois_names.txt"), sep = "\t", row.names = F, quote = F)
write.table(lang_selective_rois, here("results", "tables", "atlas_lang_selective_rois_names.txt"), sep = "\t", row.names = F, quote = F)
```

### (Optional) Check: Language-selective and language-responsive ROIs

For each class of model results, check the number of parcels by atlas and hemisphere

```{r}
gss772_responsive_rois %>% 
  mutate(atlas = "GSS_n772") %>% 
  group_by(atlas, hemi) %>% 
  count()

gss772_selective_rois %>% 
  mutate(atlas = "GSS_n772") %>% 
  group_by(atlas, hemi) %>% 
  count()

lang_responsive_rois %>%
  group_by(atlas, hemi) %>%
  count()

lang_selective_rois %>%
  group_by(atlas, hemi) %>%
  count()
```